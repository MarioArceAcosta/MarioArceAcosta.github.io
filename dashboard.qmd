---
title: "Dashboard"
engine: knitr
categories: [Research, Dashboard Economics, Higher Education]
format: 
  dashboard:
    orientation: columns
---

```{r setup, include=FALSE}
#| include: false
# 1. Force the correct path before anything else starts
Sys.setenv(RETICULATE_PYTHON = "C:/Users/Mario Arce Acosta/OneDrive/Documents/.virtualenvs/stats-env/Scripts/python.exe")
# 2. Load reticulate
library(reticulate)
# 3. Tell reticulate to strictly use your stats-env
use_virtualenv("stats-env", required = TRUE)
# 4. Install every missing piece of your "Tech Stack"
# This fixes: ModuleNotFoundError and ImportError
py_install(c("pandas", "numpy", "sqlalchemy", "psycopg2", "plotly"), 
           envname = "stats-env")
# 5. Verify it worked
py_config()
```

```{python}
#| include: true
###################FIRST QUERY#####################
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from sqlalchemy import create_engine

# 1. Create the connection engine
# Format: postgresql://[user]:[password]@[host]:[port]/[database]
engine = create_engine('postgresql://postgres:925624464@localhost:1028/ACS Final Sample')

# 2. Query the database directly into a Pandas DataFrame
noncit_count_state_query = """
SELECT 
    abv,
    COUNT(*) FILTER (WHERE noncit = 'Non-Citizen') AS noncitizen_count,
    COUNT(*) AS total_pop
FROM acs_immigration_data
GROUP BY abv
"""
df_noncit_state = pd.read_sql(noncit_count_state_query, engine)

###################SECOND QUERY#####################
counts_query = """
SELECT 
    edu_cat, 
    degfield_group,
	  stem_deg,
    gov_worker,
	  spanish_hispanic_latino,
	  nonfluent,
	  fem,
	  gbm_high_recall,
    COUNT(*) as total
FROM acs_immigration_data
GROUP BY 
    edu_cat, degfield_group, stem_deg, gov_worker, spanish_hispanic_latino, nonfluent, fem, gbm_high_recall;
"""
df_counts = pd.read_sql(counts_query, engine)
```

# Demographics (grouped bar)

##  {.sidebar}

This dashboard analyzes labor market trends and immigration flows.

-   **Filters:** Use the dropdowns on the charts to filter by Year.
-   **Tech Stack:** Python, Plotly, PostgreSQL.
-   **Data Source:** Sample Labor Statistics.

## Row {.fill}

```{python}
#| echo: false
#| fig-show: hide
#| include: false

import plotly.graph_objects as go
import pandas as pd

# 1. SETUP
variables = ['degfield_group', 'stem_deg', 'gov_worker', 'spanish_hispanic_latino', 'nonfluent', 'fem']
fig = go.Figure()

# Colors
COLOR_TOTAL = '#D3D3D3'  # Light Grey
COLOR_SUB   = '#2E86C1'  # Strong Blue

target_group = '1' 

for var in variables:
    # --- A. Total Population (Grey) ---
    summary_total = df_counts.groupby(var)['total'].sum().reset_index()
    summary_total['pct'] = (summary_total['total'] / summary_total['total'].sum()) * 100
    
    # --- B. Subgroup (Blue) ---
    df_sub = df_counts[df_counts['gbm_high_recall'].astype(str).str.strip() == target_group]
    summary_sub = df_sub.groupby(var)['total'].sum().reset_index()
    
    total_sub_count = summary_sub['total'].sum()
    if total_sub_count > 0:
        summary_sub['pct'] = (summary_sub['total'] / total_sub_count) * 100
    else:
        summary_sub['pct'] = 0

    # --- C. Cleaning & Mapping ---
    for df_temp in [summary_total, summary_sub]:
        if df_temp.empty: continue
        
        if var == 'stem_deg':
            df_temp[var] = df_temp[var].astype(str).map({'1': 'STEM Degree', '1.0': 'STEM Degree', '0': 'Non-STEM', '0.0': 'Non-STEM'}).fillna(df_temp[var])
        elif var == 'fem':
            df_temp[var] = df_temp[var].astype(str).map({'0': 'Male', '1': 'Female'}).fillna('Unknown')
        elif var == 'nonfluent':
            df_temp[var] = df_temp[var].astype(str).map({'1': 'Not Fluent', '0': 'Fluent'}).fillna(df_temp[var])
        elif var == 'spanish_hispanic_latino':
             df_temp[var] = df_temp[var].astype(str).map({'1': 'Hispanic/Latino', '0': 'Not Hispanic'}).fillna('Other')
        elif var == 'gov_worker':
             df_temp[var] = df_temp[var].astype(str).map({'1': 'Gov Worker', '0': 'Private Sector'}).fillna('Other')

    # Legend Names
    clean_name = var.replace('_', ' ').title()
    if var == 'stem_deg': clean_name = "STEM Status"
    if var == 'degfield_group': clean_name = "Field of Degree"
    if var == 'gov_worker': clean_name = "Work Sector"
    if var == 'nonfluent': clean_name = "English Proficiency"
    if "Hispanic" in clean_name: clean_name = "Ethnicity"
    if "Fem" in clean_name: clean_name = "Gender"

    # --- D. Add Traces (WITH HOVER DATA) ---
    fig.add_trace(go.Bar(
        x=summary_total[var], 
        y=summary_total['pct'],
        name="Total Population",
        visible=(var == variables[0]),
        marker_color=COLOR_TOTAL,
        customdata=summary_total['total'],
        hovertemplate='<b>%{x}</b><br>Count: %{customdata:,}<br>Percent: %{y:.1f}%<extra></extra>'
    ))

    fig.add_trace(go.Bar(
        x=summary_sub[var], 
        y=summary_sub['pct'],
        name="Undocumented",
        visible=(var == variables[0]),
        marker_color=COLOR_SUB,
        customdata=summary_sub['total'],
        hovertemplate='<b>%{x}</b><br>Count: %{customdata:,}<br>Percent: %{y:.1f}%<extra></extra>'
    ))

# 3. Buttons
buttons = []
pad_prefix = "\u00A0" * 4

for i, var in enumerate(variables):
    visibility = [False] * (len(variables) * 2)
    visibility[2*i] = True
    visibility[2*i + 1] = True
    
    clean_label = var.replace('_', ' ').title()
    if var == 'stem_deg': clean_label = "STEM Status"
    if var == 'degfield_group': clean_label = "Field of Degree"
    if var == 'gov_worker': clean_label = "Work Sector"
    if var == 'nonfluent': clean_label = "English Proficiency"
    if "Hispanic" in clean_label: clean_label = "Ethnicity"
    if "Fem" in clean_label: clean_label = "Gender"
    
    # Angle 45 (Slanted Right)
    angle = 45 if var == 'degfield_group' else 0
    # Increase bottom margin for Long Labels + Legend
    margin_b = 200 if var == 'degfield_group' else 100

    button = dict(
        label=f"{pad_prefix}{clean_label}",
        method="update",
        args=[
            {"visible": visibility}, 
            {
                "title": f"Distribution by {clean_label}",
                "xaxis.tickangle": angle,
                "margin.b": margin_b,
                "yaxis.title": "Percentage (%)"
            }
        ],
    )
    buttons.append(button)

# 4. Layout 
_ = fig.update_layout(
    barmode='group',
    template="plotly_white",
    
    # FIX: Legend at Bottom Center
    legend=dict(
        orientation="h",   # Horizontal
        yanchor="top",     # Anchor to the top of the legend box
        y=-0.35,           # Push it way down below the axis labels
        xanchor="center",  # Center it
        x=0.5
    ),

    xaxis=dict(tickangle=45 if variables[0] == 'degfield_group' else 0, automargin=True),
    
    updatemenus=[dict(
        type="buttons", direction="down", active=0, buttons=buttons, showactive=True,
        bgcolor='#eeeeee', bordercolor='white', borderwidth=2,
        x=-0.25, y=1.0, xanchor="left", yanchor="top", pad={"r": 10, "t": 10}
    )],
    title=dict(text=f"Distribution by Field of Degree", x=0.05),
    
    # Initial Margin (Must be large enough for the Degree Field labels + Legend)
    margin=dict(t=50, b=200 if variables[0] == 'degfield_group' else 100, l=250, r=50)
)
```

```{python}
fig.show()
```

# Map

```{python}
#| echo: false
#| include: false
# Create a Choropleth Map with an Animation Slider for Years
fig_map = px.choropleth(
    df_noncit_state,
    locations='abv',
    locationmode="USA-states",
    color='noncitizen_count',
    #animation_frame='Year', # This adds the continuous slider
    scope="usa",
    color_continuous_scale="Viridis",
    title="Noncitizen Count by State"
)
fig_map.update_layout(margin={"r":0,"t":40,"l":0,"b":0})
fig_map
```

```{python}
### Always important that code with plots has #| include: false in it, as well as this follow up chunk where the figure is explicitly called
fig_map
```
