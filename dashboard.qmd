---
title: "Dashboard"
engine: knitr
categories: [Research, Dashboard Economics, Higher Education]
format: 
  dashboard:
    orientation: columns
---

```{r setup, include=FALSE}
#| include: false
# 1. Force the correct path before anything else starts
Sys.setenv(RETICULATE_PYTHON = "C:/Users/Mario Arce Acosta/OneDrive/Documents/.virtualenvs/stats-env/Scripts/python.exe")
# 2. Load reticulate
library(reticulate)
# 3. Tell reticulate to strictly use your stats-env
use_virtualenv("stats-env", required = TRUE)
# 4. Install every missing piece of your "Tech Stack"
# This fixes: ModuleNotFoundError and ImportError
py_install(c("pandas", "numpy", "sqlalchemy", "psycopg2", "plotly"), 
           envname = "stats-env")
# 5. Verify it worked
py_config()
```

```{python}
#| include: false
###################FIRST QUERY#####################
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from sqlalchemy import create_engine

# 1. Create the connection engine
# Format: postgresql://[user]:[password]@[host]:[port]/[database]
engine = create_engine('postgresql://postgres:925624464@localhost:1028/ACS Final Sample')

# 2. Query the database directly into a Pandas DataFrame
noncit_count_state_query = """
SELECT 
    abv,
    COUNT(*) FILTER (WHERE noncit = 'Non-Citizen') AS noncitizen_count,
    COUNT(*) AS total_pop
FROM acs_immigration_data
GROUP BY abv
"""
df_noncit_state = pd.read_sql(noncit_count_state_query, engine)

###################SECOND QUERY#####################
counts_query = """
SELECT 
    edu_cat, 
    degfield_group,
	  stem_deg,
    gov_worker,
	  spanish_hispanic_latino,
	  nonfluent,
	  fem,
    COUNT(*) as total
FROM acs_immigration_data
GROUP BY edu_cat, degfield_group, stem_deg, gov_worker, spanish_hispanic_latino, nonfluent, fem;
"""
df_counts = pd.read_sql(counts_query, engine)
```

# Demographics (Bar Chart)

##  {.sidebar}

This dashboard analyzes labor market trends and immigration flows.

-   **Filters:** Use the dropdowns on the charts to filter by Year.
-   **Tech Stack:** Python, Plotly, PostgreSQL.
-   **Data Source:** Sample Labor Statistics.

## Row {.fill}

```{python}
#| echo: false
#| fig-show: hide
#| include: false


import plotly.graph_objects as go
import pandas as pd

# (Assuming df_counts is already loaded)
variables = ['edu_cat', 'degfield_group', 'stem_deg', 'gov_worker', 'spanish_hispanic_latino', 'nonfluent', 'fem']

fig = go.Figure()

# --- 1. DESIGN CHOICE: Professional Color ---
BAR_COLOR = '#2E86C1' 

for var in variables:
    summary = df_counts.groupby(var)['total'].sum().reset_index()
    
    # Logic to fix long labels in the legend/hover
    clean_name = var.replace('_', ' ').title()
    if "Hispanic" in clean_name:
        clean_name = "Hispanic/Latino"

    fig.add_trace(
        go.Bar(
            x=summary[var], 
            y=summary['total'], 
            name=clean_name,
            visible=(var == variables[0]),
            
            # --- IMPROVEMENT: Custom Color & Text ---
            marker_color=BAR_COLOR,       
            text=summary['total'],        
            texttemplate='%{text:,.0f}',  
            textposition='auto',          
            hovertemplate='<b>%{x}</b><br>Count: %{y:,.0f}<extra></extra>' 
        )
    )

# --- 2. IMPROVEMENT: Smart Buttons ---
buttons = []
for i, var in enumerate(variables):
    visibility = [False] * len(variables)
    visibility[i] = True
    
    # Inside the loop creating buttons:
    clean_label = var.replace('_', ' ').title()

    # Add extra spaces to the end of the text to force the box wider
    # This doesn't show up visually but forces the container to expand
    button_label = clean_label + "          " 

    button = dict(
        label=button_label,  # Use the padded label here
        method="update",
        args=[
            {"visible": visibility}, 
            {"title": f"Total Count by {clean_label}"}
        ]
    )
    buttons.append(button)

# --- 3. IMPROVEMENT: Clean Layout ---
fig.update_layout(
    template="plotly_white", 
    
    updatemenus=[dict(
        type="dropdown",  
        direction="down",
        active=0,
        buttons=buttons,
        
        # --- FIX: Force Width with Padding ---
        # 'r': 80 adds 80px of padding to the right, elongating the button.
        # 't': 10 gives it space from the top.
        pad={"r": 80, "t": 10}, 
        
        x=0.0, 
        y=1.2,
        xanchor="left", 
        yanchor="top",
        bgcolor='white',  
        bordercolor='lightgrey'
    )],
    
    title=dict(
        text=f"Total Count by {variables[0].replace('_', ' ').title()}",
        font=dict(size=20),
        y=0.95 # Ensure title doesn't overlap with menu
    ),
    
    xaxis=dict(title="Category", tickfont=dict(size=12)),
    yaxis=dict(title="Total Count", showgrid=True, gridcolor='lightgrey'),
    
    # --- FIX: Increased Top Margin ---
    # Increased 't' to 150 to ensure the menu doesn't get cut off by the browser
    margin=dict(t=150, b=50, l=50, r=50)
)
```

```{python}
fig.show()
```


# Map


## Row {.fill}

```{python}
#| echo: false
#| include: false
# Create a Choropleth Map with an Animation Slider for Years
fig_map = px.choropleth(
    df_noncit_state,
    locations='abv',
    locationmode="USA-states",
    color='noncitizen_count',
    #animation_frame='Year', # This adds the continuous slider
    scope="usa",
    color_continuous_scale="Viridis",
    title="Noncitizen Count by State"
)
fig_map.update_layout(margin={"r":0,"t":40,"l":0,"b":0})
fig_map
```

```{python}
### Always important that code with plots has #| include: false in it, as well as this follow up chunk where the figure is explicitly called
fig_map
```

