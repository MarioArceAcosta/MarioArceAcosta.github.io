---
title: "Interactive Analytics"
engine: knitr
format: 
  dashboard:
    theme: cosmo
    orientation: rows
---

```{r setup, include=FALSE}
# 1. Force the correct path before anything else starts
Sys.setenv(RETICULATE_PYTHON = "C:/Users/Mario Arce Acosta/OneDrive/Documents/.virtualenvs/stats-env/Scripts/python.exe")

# 2. Load reticulate
library(reticulate)

# 3. Tell reticulate to strictly use your stats-env
use_virtualenv("stats-env", required = TRUE)

# 4. Install every missing piece of your "Tech Stack"
# This fixes: ModuleNotFoundError and ImportError
py_install(c("pandas", "numpy", "sqlalchemy", "psycopg2", "plotly"), 
           envname = "stats-env")

# 5. Verify it worked
py_config()
```

```{python}
import pandas as pd
import plotly.express as px
from sqlalchemy import create_engine

# 1. Create the connection engine
# Format: postgresql://[user]:[password]@[host]:[port]/[database]
engine = create_engine('postgresql://postgres:925624464@localhost:1028/ACS Final Sample')

# 2. Query the database directly into a Pandas DataFrame
noncit_count_state_query = """
SELECT 
    abv,
    COUNT(*) FILTER (WHERE noncit = 'Non-Citizen') AS noncitizen_count,
    COUNT(*) AS total_pop
FROM acs_immigration_data
GROUP BY abv
"""

df_noncit_state = pd.read_sql(noncit_count_state_query, engine)
```

# Map

##  {.sidebar}

This dashboard analyzes labor market trends and immigration flows.

-   **Filters:** Use the dropdowns on the charts to filter by Year.
-   **Tech Stack:** Python, Plotly, PostgreSQL.
-   **Data Source:** Sample Labor Statistics.

## Row {height="60%"}

### Map of Location Counts

```{python}
# Create a Choropleth Map with an Animation Slider for Years
fig_map = px.choropleth(
    df_noncit_state,
    locations='abv',
    locationmode="USA-states",
    color='noncitizen_count',
    #animation_frame='Year', # This adds the continuous slider
    scope="usa",
    color_continuous_scale="Viridis",
    title="Noncitizen Count by State"
)

fig_map.update_layout(margin={"r":0,"t":40,"l":0,"b":0})
fig_map.show()
```
