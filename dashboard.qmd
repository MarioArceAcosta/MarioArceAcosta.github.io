---
title: "Dashboard"
engine: knitr
format: 
  dashboard:
    orientation: columns
---

```{r setup, include=FALSE}
#| include: false
# 1. Force the correct path before anything else starts
Sys.setenv(RETICULATE_PYTHON = "C:/Users/Mario Arce Acosta/OneDrive/Documents/.virtualenvs/stats-env/Scripts/python.exe")
# 2. Load reticulate
library(reticulate)
# 3. Tell reticulate to strictly use your stats-env
use_virtualenv("stats-env", required = TRUE)
# 4. Install every missing piece of your "Tech Stack"
# This fixes: ModuleNotFoundError and ImportError
py_install(c("pandas", "numpy", "sqlalchemy", "psycopg2", "plotly"), 
           envname = "stats-env")
# 5. Verify it worked
py_config()
```

```{python}
#| include: false
###################FIRST QUERY#####################
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from sqlalchemy import create_engine

# 1. Create the connection engine
# Format: postgresql://[user]:[password]@[host]:[port]/[database]
engine = create_engine('postgresql://postgres:925624464@localhost:1028/ACS Final Sample')

# 2. Query the database directly into a Pandas DataFrame
noncit_count_state_query = """
SELECT 
    abv,
    COUNT(*) FILTER (WHERE noncit = 'Non-Citizen') AS noncitizen_count,
    COUNT(*) AS total_pop
FROM acs_immigration_data
GROUP BY abv
"""
df_noncit_state = pd.read_sql(noncit_count_state_query, engine)

###################SECOND QUERY#####################
counts_query = """
SELECT 
    edu_cat, 
    degfield_group,
	  stem_deg,
    gov_worker,
	  spanish_hispanic_latino,
	  nonfluent,
	  fem,
    COUNT(*) as total
FROM acs_immigration_data
GROUP BY edu_cat, degfield_group, stem_deg, gov_worker, spanish_hispanic_latino, nonfluent, fem;
"""
df_counts = pd.read_sql(counts_query, engine)
```

# Map

##  {.sidebar}

This dashboard analyzes labor market trends and immigration flows.

-   **Filters:** Use the dropdowns on the charts to filter by Year.
-   **Tech Stack:** Python, Plotly, PostgreSQL.
-   **Data Source:** Sample Labor Statistics.

## Row {.fill}

```{python}
#| echo: false
#| include: false
# Create a Choropleth Map with an Animation Slider for Years
fig_map = px.choropleth(
    df_noncit_state,
    locations='abv',
    locationmode="USA-states",
    color='noncitizen_count',
    #animation_frame='Year', # This adds the continuous slider
    scope="usa",
    color_continuous_scale="Viridis",
    title="Noncitizen Count by State"
)
fig_map.update_layout(margin={"r":0,"t":40,"l":0,"b":0})
fig_map
```

```{python}
### Always important that code with plots has #| include: false in it, as well as this follow up chunk where the figure is explicitly called
fig_map
```

# Any bar chart

```{python}
#| echo: false
#| fig-show: hide
#| include: false
variables = ['edu_cat', 'degfield_group', 'stem_deg', 'gov_worker', 'spanish_hispanic_latino', 'nonfluent', 'fem']

fig = go.Figure()

# 1. Build a separate bar chart (trace) for every variable in your list
for var in variables:
    summary = df_counts.groupby(var)['total'].sum().reset_index()
    
    fig.add_trace(
        go.Bar(
            x=summary[var], 
            y=summary['total'], 
            name=var,
            visible=(var == variables[0])
        )
    )

# 2. Create the Dropdown Buttons
buttons = []
for i, var in enumerate(variables):
    visibility = [False] * len(variables)
    visibility[i] = True
    
    button = dict(
        label=var.replace('_', ' ').title(),
        method="update",
        args=[{"visible": visibility}, {"title": f"Count by {var.title()}"}]
    )
    buttons.append(button)

# 3. Add the UI Menu to the Layout
fig.update_layout(
    updatemenus=[dict(
        active=0,
        buttons=buttons,
        x=0.1, y=1.2,
        showactive=True
    )],
    title=f"Count by {variables[0].title()}",
    xaxis_title="Category",
    yaxis_title="Total Count"
)
```

```{python}
fig.show()
```
